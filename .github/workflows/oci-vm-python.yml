name: Launch OCI Free-Tier VM

on:
  workflow_dispatch:

jobs:
  launch-vm:
    runs-on: ubuntu-latest

    steps:
      - name: 🔧 Install OCI CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3 python3-pip
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh > install.sh
          chmod +x install.sh
          ./install.sh --accept-all-defaults --install-dir /home/runner --exec-dir /home/runner/bin
          echo "/home/runner/bin" >> $GITHUB_PATH

      - name: ⚙️ Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          cat <<EOF > ~/.oci/config
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=/home/runner/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          EOF

          chmod 600 ~/.oci/config
          oci --version
          echo "✅ OCI CLI is ready"

      - name: 🚀 Launching Free-Tier VM
        run: |
          echo "⏳ Launching free-tier VM..."
          echo "🖼️ Using Image ID: ${{ secrets.OCI_IMAGE_ID }}"

          INSTANCE_ID=$(oci compute instance launch \
            --availability-domain "${{ secrets.OCI_AD }}" \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --shape "VM.Standard.E2.1.Micro" \
            --display-name "github-actions-vm" \
            --image-id "${{ secrets.OCI_IMAGE_ID }}" \
            --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
            --assign-public-ip true \
            --metadata '{"ssh_authorized_keys":"${{ secrets.OCI_SSH_PUBLIC_KEY }}"}' \
            --wait-for-state RUNNING \
            --query "data.id" \
            --raw-output)

          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          echo "✅ VM Launched: $INSTANCE_ID"

      - name: 🌐 Fetch Public IP
        run: |
          echo "🌐 Fetching public IP..."
          PUBLIC_IP=$(oci compute instance list-vnics \
            --instance-id "$INSTANCE_ID" \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --query "data[0].\"public-ip\"" \
            --raw-output)

          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "🔗 VM Public IP: $PUBLIC_IP"
