name: Launch OCI Free-Tier VM

on:
  workflow_dispatch:

jobs:
  launch-vm:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Install OCI CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3 python3-pip python3-venv
          rm -rf $HOME/oci-cli $HOME/bin/oci  # Cleanup if rerunning
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh -o install.sh
          chmod +x install.sh
          ./install.sh --accept-all-defaults --install-dir $HOME/oci-cli
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: üõ†Ô∏è Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          cat <<EOF > ~/.oci/config
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=/home/runner/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          EOF

          chmod 600 ~/.oci/config
          oci --version

      - name: üöÄ Launch Free-Tier VM
        run: |
          echo "‚è≥ Launching free-tier VM..."
          AD_NAME=$(oci iam availability-domain list --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} --query "data[0].name" --raw-output)

          INSTANCE_ID=$(oci compute instance launch \
            --availability-domain "$AD_NAME" \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --shape "VM.Standard.E2.1.Micro" \
            --display-name "github-actions-vm" \
            --subnet-id ${{ secrets.OCI_SUBNET_OCID }} \
            --assign-public-ip true \
            --image-id "${{ secrets.OCI_IMAGE_ID }}" \
            --metadata '{"ssh_authorized_keys":"'"${{ secrets.OCI_SSH_PUBLIC_KEY }}"'"}' \
            --query "data.id" \
            --raw-output \
            --wait-for-state RUNNING)

          echo "‚úÖ Instance ID: $INSTANCE_ID"
