name: Launch Free OCI VM

on:
  workflow_dispatch:

jobs:
  launch-vm:
    name: Launch Free-Tier VM Only
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install OCI CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip python3 python3-pip
        curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh > install.sh
        chmod +x install.sh
        ./install.sh --accept-all-defaults <<< ''
        echo "$HOME/bin" >> $GITHUB_PATH
        export PATH=$PATH:$HOME/bin
        echo "✅ OCI CLI Installed"

    - name: Configure OCI CLI
      run: |
        mkdir -p ~/.oci
        echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
        chmod 600 ~/.oci/oci_api_key.pem

        cat <<EOF > ~/.oci/config
        [DEFAULT]
        user=${{ secrets.OCI_USER_OCID }}
        fingerprint=${{ secrets.OCI_FINGERPRINT }}
        key_file=/home/runner/.oci/oci_api_key.pem
        tenancy=${{ secrets.OCI_TENANCY_OCID }}
        region=${{ secrets.OCI_REGION }}
        EOF

        chmod 600 ~/.oci/config
        echo "✅ OCI CLI configured"
        oci --version

    - name: Launch Free-Tier Ubuntu VM
      run: |
        echo "⏳ Launching free-tier VM..."

        AD=$(oci iam availability-domain list \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
          --query "data[0].name" \
          --raw-output)

        IMAGE_ID=$(oci compute image list \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
          --query "data[?contains(\"display-name\", 'Ubuntu') && contains(\"display-name\", '22.04')].id | [0]" \
          --region ${{ secrets.OCI_REGION }} \
          --raw-output)

        echo "✅ Ubuntu Image ID: $IMAGE_ID"

        INSTANCE_ID=$(oci compute instance launch \
          --availability-domain "$AD" \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
          --shape "VM.Standard.E2.1.Micro" \
          --display-name "github-actions-vm" \
          --subnet-id ${{ secrets.OCI_SUBNET_OCID }} \
          --assign-public-ip true \
          --image-id "$IMAGE_ID" \
          --metadata '{"ssh_authorized_keys": "${{ secrets.OCI_SSH_PUBLIC_KEY }}"}' \
          --wait-for-state RUNNING \
          --query "data.id" --raw-output)

        echo "✅ VM launched with INSTANCE_ID: $INSTANCE_ID"
